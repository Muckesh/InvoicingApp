<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2 {
            color: #2c3e50;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        table, th, td {
            border: 1px solid #ddd;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        input, select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .invoice-items {
            margin-top: 20px;
        }
        
        .item-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        
        .item-row select, .item-row input {
            flex: 1;
        }
        
        .item-row button {
            flex: 0 0 auto;
            padding: 8px 12px;
        }
        
        .hidden {
            display: none;
        }
        
        #invoice-preview {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            background: white;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .invoice-totals {
            margin-top: 20px;
            text-align: right;
        }
        
        .total-amount {
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Invoice Generator</h1>
        
        <div class="section">
            <h2>Customers</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="customer-name">Name</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label for="customer-email">Email</label>
                    <input type="email" id="customer-email">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="customer-phone">Phone</label>
                    <input type="text" id="customer-phone">
                </div>
                <div class="form-group">
                    <label for="customer-address">Address</label>
                    <input type="text" id="customer-address">
                </div>
            </div>
            <button id="add-customer">Add Customer</button>
            
            <h3>Customer List</h3>
            <table id="customers-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>Products</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="product-name">Name</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-price">Price</label>
                    <input type="number" id="product-price" min="0" step="0.01" required>
                </div>
            </div>
            <div class="form-group">
                <label for="product-description">Description</label>
                <input type="text" id="product-description">
            </div>
            <button id="add-product">Add Product</button>
            
            <h3>Product List</h3>
            <table id="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>Create Invoice</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="invoice-customer">Customer</label>
                    <select id="invoice-customer" required></select>
                </div>
                <div class="form-group">
                    <label for="invoice-due-date">Due Date</label>
                    <input type="date" id="invoice-due-date" required>
                </div>
            </div>
            
            <h3>Invoice Items</h3>
            <div class="invoice-items">
                <div class="item-row">
                    <select class="invoice-product" required>
                        <option value="">Select Product</option>
                    </select>
                    <input type="number" class="invoice-quantity" min="1" value="1" required>
                    <button class="add-item">Add Item</button>
                </div>
                <div id="invoice-items-list"></div>
            </div>
            
            <button id="create-invoice">Create Invoice</button>
            
            <div id="invoice-preview" class="hidden">
                <h2>Invoice Preview</h2>
                <div class="invoice-header">
                    <div>
                        <h3 id="preview-customer-name"></h3>
                        <div id="preview-customer-details"></div>
                    </div>
                    <div>
                        <p><strong>Invoice #:</strong> <span id="preview-invoice-id"></span></p>
                        <p><strong>Date:</strong> <span id="preview-invoice-date"></span></p>
                        <p><strong>Due Date:</strong> <span id="preview-due-date"></span></p>
                    </div>
                </div>
                
                <table id="preview-items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <div class="invoice-totals">
                    <p class="total-amount">Total: $<span id="preview-total-amount">0.00</span></p>
                </div>
                
                <button id="print-invoice">Print Invoice</button>
                <button id="new-invoice">Create New Invoice</button>
            </div>
        </div>
        
        <div class="section">
            <h2>Invoice List</h2>
            <table id="invoices-table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Due Date</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // Global variables
        let customers = [];
        let products = [];
        let invoices = [];
        let currentInvoiceItems = [];
        
        // DOM elements
        const customersTable = document.getElementById('customers-table').getElementsByTagName('tbody')[0];
        const productsTable = document.getElementById('products-table').getElementsByTagName('tbody')[0];
        const invoicesTable = document.getElementById('invoices-table').getElementsByTagName('tbody')[0];
        const invoiceCustomerSelect = document.getElementById('invoice-customer');
        const invoiceProductSelect = document.querySelector('.invoice-product');
        const invoiceItemsList = document.getElementById('invoice-items-list');
        const invoicePreview = document.getElementById('invoice-preview');
        
        // API URLs
        const apiUrl = window.location.origin;
        const customersUrl = `${apiUrl}/api/customer`;
        const productsUrl = `${apiUrl}/api/product`;
        const invoicesUrl = `${apiUrl}/api/invoice`;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default due date to 30 days from now
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('invoice-due-date').valueAsDate = dueDate;
            
            // Load initial data
            loadCustomers();
            loadProducts();
            loadInvoices();
            
            // Set up event listeners
            document.getElementById('add-customer').addEventListener('click', addCustomer);
            document.getElementById('add-product').addEventListener('click', addProduct);
            document.getElementById('create-invoice').addEventListener('click', createInvoice);
            document.querySelector('.add-item').addEventListener('click', addInvoiceItem);
            document.getElementById('print-invoice').addEventListener('click', printInvoice);
            document.getElementById('new-invoice').addEventListener('click', resetInvoiceForm);
        });
        
        // Load customers from API
        async function loadCustomers() {
            try {
                const response = await fetch(customersUrl);
                customers = await response.json();
                renderCustomers();
                updateCustomerDropdowns();
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }
        
        // Render customers table
        function renderCustomers() {
            customersTable.innerHTML = '';
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.customerId}</td>
                    <td>${customer.name}</td>
                    <td>${customer.email || ''}</td>
                    <td>${customer.phone || ''}</td>
                    <td>
                        <button onclick="deleteCustomer(${customer.customerId})">Delete</button>
                    </td>
                `;
                customersTable.appendChild(row);
            });
        }
        
        // Add a new customer
        async function addCustomer() {
            const name = document.getElementById('customer-name').value.trim();
            const email = document.getElementById('customer-email').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const address = document.getElementById('customer-address').value.trim();
            
            if (!name) {
                alert('Name is required');
                return;
            }
            
            const customer = {
                name,
                email,
                phone,
                address
            };
            
            try {
                const response = await fetch(customersUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customer)
                });
                
                if (response.ok) {
                    document.getElementById('customer-name').value = '';
                    document.getElementById('customer-email').value = '';
                    document.getElementById('customer-phone').value = '';
                    document.getElementById('customer-address').value = '';
                    loadCustomers();
                } else {
                    alert('Error adding customer');
                }
            } catch (error) {
                console.error('Error adding customer:', error);
            }
        }
        
        // Delete a customer
        async function deleteCustomer(id) {
            if (!confirm('Are you sure you want to delete this customer?')) {
                return;
            }
            
            try {
                const response = await fetch(`${customersUrl}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadCustomers();
                } else {
                    alert('Error deleting customer');
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
            }
        }
        
        // Load products from API
        async function loadProducts() {
            try {
                const response = await fetch(productsUrl);
                products = await response.json();
                renderProducts();
                updateProductDropdowns();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // Render products table
        function renderProducts() {
            productsTable.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.productId}</td>
                    <td>${product.name}</td>
                    <td>${product.description || ''}</td>
                    <td>$${product.price.toFixed(2)}</td>
                    <td>
                        <button onclick="deleteProduct(${product.productId})">Delete</button>
                    </td>
                `;
                productsTable.appendChild(row);
            });
        }
        
        // Add a new product
        async function addProduct() {
            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const description = document.getElementById('product-description').value.trim();
            
            if (!name || isNaN(price)) {
                alert('Name and valid price are required');
                return;
            }
            
            const product = {
                name,
                price,
                description
            };
            
            try {
                const response = await fetch(productsUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(product)
                });
                
                if (response.ok) {
                    document.getElementById('product-name').value = '';
                    document.getElementById('product-price').value = '';
                    document.getElementById('product-description').value = '';
                    loadProducts();
                } else {
                    alert('Error adding product');
                }
            } catch (error) {
                console.error('Error adding product:', error);
            }
        }
        
        // Delete a product
        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            try {
                const response = await fetch(`${productsUrl}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadProducts();
                } else {
                    alert('Error deleting product');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }
        
        // Load invoices from API
        async function loadInvoices() {
            try {
                const response = await fetch(invoicesUrl);
                invoices = await response.json();
                renderInvoices();
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        }
        
        // Render invoices table
        function renderInvoices() {
            invoicesTable.innerHTML = '';
            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${invoice.invoiceId}</td>
                    <td>${invoice.customer.name}</td>
                    <td>${new Date(invoice.invoiceDate).toLocaleDateString()}</td>
                    <td>${new Date(invoice.dueDate).toLocaleDateString()}</td>
                    <td>$${invoice.totalAmount.toFixed(2)}</td>
                    <td>${invoice.status}</td>
                    <td>
                        <button onclick="viewInvoice(${invoice.invoiceId})">View</button>
                        <button onclick="deleteInvoice(${invoice.invoiceId})">Delete</button>
                    </td>
                `;
                invoicesTable.appendChild(row);
            });
        }
        
        // View an invoice
        async function viewInvoice(id) {
            try {
                const response = await fetch(`${invoicesUrl}/${id}`);
                const invoice = await response.json();
                
                // Populate preview
                document.getElementById('preview-invoice-id').textContent = invoice.invoiceId;
                document.getElementById('preview-invoice-date').textContent = new Date(invoice.invoiceDate).toLocaleDateString();
                document.getElementById('preview-due-date').textContent = new Date(invoice.dueDate).toLocaleDateString();
                document.getElementById('preview-customer-name').textContent = invoice.customer.name;
                
                let customerDetails = '';
                if (invoice.customer.email) customerDetails += `<p>Email: ${invoice.customer.email}</p>`;
                if (invoice.customer.phone) customerDetails += `<p>Phone: ${invoice.customer.phone}</p>`;
                if (invoice.customer.address) customerDetails += `<p>Address: ${invoice.customer.address}</p>`;
                document.getElementById('preview-customer-details').innerHTML = customerDetails;
                
                const itemsTable = document.getElementById('preview-items-table').getElementsByTagName('tbody')[0];
                itemsTable.innerHTML = '';
                
                invoice.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.product.name}</td>
                        <td>${item.product.description || ''}</td>
                        <td>${item.quantity}</td>
                        <td>$${item.unitPrice.toFixed(2)}</td>
                        <td>$${(item.quantity * item.unitPrice).toFixed(2)}</td>
                    `;
                    itemsTable.appendChild(row);
                });
                
                document.getElementById('preview-total-amount').textContent = invoice.totalAmount.toFixed(2);
                
                // Show preview
                invoicePreview.classList.remove('hidden');
                window.scrollTo(0, document.body.scrollHeight);
            } catch (error) {
                console.error('Error viewing invoice:', error);
            }
        }
        
        // Delete an invoice
        async function deleteInvoice(id) {
            if (!confirm('Are you sure you want to delete this invoice?')) {
                return;
            }
            
            try {
                const response = await fetch(`${invoicesUrl}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadInvoices();
                } else {
                    alert('Error deleting invoice');
                }
            } catch (error) {
                console.error('Error deleting invoice:', error);
            }
        }
        
        // Update customer dropdowns
        function updateCustomerDropdowns() {
            invoiceCustomerSelect.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.customerId;
                option.textContent = customer.name;
                invoiceCustomerSelect.appendChild(option);
            });
        }
        
        // Update product dropdowns
        function updateProductDropdowns() {
            const productSelects = document.querySelectorAll('.invoice-product');
            productSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Product</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.productId;
                    option.textContent = `${product.name} ($${product.price.toFixed(2)})`;
                    select.appendChild(option);
                });
            });
        }
        
        // Add item to current invoice
        function addInvoiceItem() {
            const productSelect = this.parentElement.querySelector('.invoice-product');
            const quantityInput = this.parentElement.querySelector('.invoice-quantity');
            
            const productId = parseInt(productSelect.value);
            const quantity = parseInt(quantityInput.value);
            
            if (!productId || isNaN(quantity) || quantity < 1) {
                alert('Please select a product and enter a valid quantity');
                return;
            }
            
            const product = products.find(p => p.productId === productId);
            
            currentInvoiceItems.push({
                productId,
                quantity,
                unitPrice: product.price,
                product
            });
            
            renderInvoiceItems();
            
            // Reset the inputs
            productSelect.value = '';
            quantityInput.value = '1';
        }
        
        // Render current invoice items
        function renderInvoiceItems() {
            invoiceItemsList.innerHTML = '';
            
            currentInvoiceItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-row';
                itemDiv.innerHTML = `
                    <input type="text" value="${item.product.name}" readonly>
                    <input type="number" value="${item.quantity}" readonly>
                    <input type="text" value="$${item.unitPrice.toFixed(2)}" readonly>
                    <input type="text" value="$${(item.quantity * item.unitPrice).toFixed(2)}" readonly>
                    <button onclick="removeInvoiceItem(${index})">Remove</button>
                `;
                invoiceItemsList.appendChild(itemDiv);
            });
        }
        
        // Remove item from current invoice
        function removeInvoiceItem(index) {
            currentInvoiceItems.splice(index, 1);
            renderInvoiceItems();
        }
        
        // Create a new invoice
        async function createInvoice() {
            const customerId = parseInt(invoiceCustomerSelect.value);
            const dueDate = document.getElementById('invoice-due-date').value;
            
            if (!customerId || !dueDate || currentInvoiceItems.length === 0) {
                alert('Please select a customer, set a due date, and add at least one item');
                return;
            }
            
            const invoiceRequest = {
                customerId,
                dueDate,
                items: currentInvoiceItems.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity
                }))
            };
            
            try {
                const response = await fetch(invoicesUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceRequest)
                });
                
                if (response.ok) {
                    const invoice = await response.json();
                    viewInvoice(invoice.invoiceId);
                    loadInvoices();
                } else {
                    alert('Error creating invoice');
                }
            } catch (error) {
                console.error('Error creating invoice:', error);
            }
        }
        
        // Print invoice
        function printInvoice() {
            window.print();
        }
        
        // Reset invoice form
        function resetInvoiceForm() {
            currentInvoiceItems = [];
            invoiceItemsList.innerHTML = '';
            invoiceCustomerSelect.value = '';
            
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('invoice-due-date').valueAsDate = dueDate;
            
            invoicePreview.classList.add('hidden');
        }
    </script>
</body>
</html>